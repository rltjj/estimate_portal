<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>성진글로벌 경영지원 서비스</title>
  <link rel="stylesheet" href="/public/css/font.css">
  <link rel="stylesheet" href="/public/css/customer.css">
</head>

<body>
  <div class="container">
    <h1>환영합니다!</h1>
    <div class="buttons">
      <button id="createEstimate">신청하기</button>
    </div>
    <p>견적서와 계약서는 로그인하신 이메일로 전송됩니다.</p>
  </div>

  <div class="container">
    <h1>신청 내역</h1>
    <table id="estimateTable">
      <thead>
        <tr>
          <th>번호</th>
          <th>상품</th>
          <th>상태</th>
          <th>신청일</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td colspan="4">신청 내역이 없습니다.</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="container delete-btn">
    <button id="deleteAccount">회원 탈퇴</button>
  </div>

  <script>
    document.getElementById('createEstimate').addEventListener('click', () => {
      window.location.href = '/checklist';
    });

    document.getElementById('deleteAccount').addEventListener('click', () => {
      if (!confirm('정말 계정을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) return;

      fetch('/app/controllers/delete_account.php', {
        method: 'POST'
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            alert('회원 탈퇴가 완료되었습니다.');
            window.location.href = '/';
          } else {
            alert('회원 탈퇴 실패: ' + data.message);
          }
        })
        .catch(err => alert('서버 오류: ' + err.message));
    });

    const estimateTableBody = document.querySelector('#estimateTable tbody');

    fetch('/app/controllers/get_applications.php')
      .then(res => res.json())
      .then(applications => {
        if (applications.error) {
          console.error('서버 에러:', applications.error);
          return;
        }

        estimateTableBody.innerHTML = '';

        if (applications.length === 0) {
          estimateTableBody.innerHTML = '<tr><td colspan="4">신청 내역이 없습니다.</td></tr>';
          return;
        }

        const statusMap = {
          REQUESTED: '신청됨',
          QUOTED: '견적됨',
          READY: '결제준비됨',
          PAID: '결제됨',
          FAILED: '실패'
        };

        applications.forEach((app, index) => {
          const tr = document.createElement('tr');
          let actionButtons = '';

          if (app.status === 'QUOTED') {
            actionButtons = '<span>이메일을 확인해주세요.</span>';
          } else if (app.status === 'READY') {
            actionButtons = `<button class="pay-btn" data-id="${app.id}">결제하러가기</button>`;
          } else if (app.status === 'PAID') {
            actionButtons = `<span>결제완료</span>`;
          } else if (app.status === 'REQUESTED') {
            actionButtons = `<button class="cancel-btn" data-id="${app.id}">신청취소</button>`;
          }

          tr.innerHTML = `
    <td>${index + 1}</td>
    <td>${app.products}</td>
    <td>${statusMap[app.status] || app.status}</td>
    <td>${app.created_at || '-'}</td>
    <td>${actionButtons}</td>
  `;
          estimateTableBody.appendChild(tr);
        });

        document.addEventListener('click', e => {
          if (e.target.classList.contains('sign-btn')) {
            const appId = e.target.dataset.id;
            window.location.href = `/app/controllers/request_signature.php?app_id=${appId}`;
          }

          if (e.target.classList.contains('pay-btn')) {
            const appId = e.target.dataset.id;
            window.location.href = `/app/controllers/request_payment.php?app_id=${appId}`;
          }

          if (e.target.classList.contains('cancel-btn')) {
            const appId = e.target.dataset.id;
            if (confirm('정말 신청을 취소하시겠습니까?')) {
              fetch(`/app/controllers/cancel_application.php`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: appId })
              })
                .then(res => res.json())
                .then(data => {
                  if (data.success) {
                    alert('신청이 취소되었습니다.');
                    e.target.closest('tr').remove();
                  } else {
                    alert('취소 실패: ' + data.message);
                  }
                })
                .catch(err => alert('서버 오류: ' + err.message));
            }
          }
        });

      })
      .catch(err => console.error('Fetch error:', err));

  </script>
</body>

</html>